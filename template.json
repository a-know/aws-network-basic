{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Resources" : {
    "MyVPC" : {
      "Type" : "AWS::EC2::VPC",
      "Properties" : {
        "CidrBlock" : "10.0.0.0/16",
        "EnableDnsSupport" : "true",
        "EnableDnsHostnames" : "true",
        "InstanceTenancy" : "default",
        "Tags" : [ {"Key" : "Name", "Value" : "VPC領域"} ]
      }
    },
    "MyPublicSubnet" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "MyVPC" },
        "CidrBlock" : "10.0.1.0/24",
        "AvailabilityZone" : "ap-northeast-1c",
        "Tags" : [ { "Key" : "Name", "Value" : "パブリックサブネット" } ]
      }
    },
    "MyPrivateSubnet" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "MyVPC" },
        "CidrBlock" : "10.0.2.0/24",
        "AvailabilityZone" : "ap-northeast-1c",
        "Tags" : [ { "Key" : "Name", "Value" : "プライベートサブネット" } ]
      }
    },
    "MyIGW" : {
      "Type" : "AWS::EC2::InternetGateway",
      "Properties" : {
        "Tags" : [ {"Key" : "Name", "Value" : "インターネットゲートウェイ"}]
      }
    },
    "AttachGateway" : {
      "Type" : "AWS::EC2::VPCGatewayAttachment",
      "Properties" : {
        "VpcId" : { "Ref" : "MyVPC" },
        "InternetGatewayId" : { "Ref" : "MyIGW" }
      }
    },
    "MyRouteTable" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : { "Ref" : "MyVPC" },
        "Tags" : [ { "Key" : "Name", "Value" : "パブリックルートテーブル" } ]
      }
    },
    "AttachPublicRouteTableToPublicSubnet" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "RouteTableId" : { "Ref" : "MyRouteTable" },
        "SubnetId" : { "Ref" : "MyPublicSubnet" }
      }
    },
    "MyRoute" : {
      "Type" : "AWS::EC2::Route",
      "Properties" : {
        "RouteTableId" : { "Ref" : "MyRouteTable" },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "GatewayId" : { "Ref" : "MyIGW" }
      }
    },
    "MyPublicSecurityGroup": {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "SecurityGroup for web-server instance in public-subnet",
        "SecurityGroupIngress" : [
          {
           "IpProtocol" : "tcp",
           "FromPort" : "22",
           "ToPort" : "22",
           "CidrIp" : "0.0.0.0/0"
         },
         {
          "IpProtocol" : "tcp",
          "FromPort" : "80",
          "ToPort" : "80",
          "CidrIp" : "0.0.0.0/0"
         }
        ],
        "Tags" :  [ { "Key" : "Name", "Value" : "WEB-SG" } ],
        "VpcId" : { "Ref" : "MyVPC" }
      }
    },
    "MyDatabaseSecurityGroup": {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "SecurityGroup for db-server instance in private-subnet",
        "SecurityGroupIngress" : [
          {
           "IpProtocol" : "tcp",
           "FromPort" : "22",
           "ToPort" : "22",
           "CidrIp" : "0.0.0.0/0"
         },
         {
          "IpProtocol" : "tcp",
          "FromPort" : "3306",
          "ToPort" : "3306",
          "CidrIp" : "0.0.0.0/0"
         },
         {
          "IpProtocol" : "icmp",
          "FromPort" : "-1",
          "ToPort" : "-1",
          "CidrIp" : "0.0.0.0/0"
         }
        ],
        "Tags" :  [ { "Key" : "Name", "Value" : "DB-SG" } ],
        "VpcId" : { "Ref" : "MyVPC" }
      }
    },
    "MyPublicEC2Instance": {
      "Type" : "AWS::EC2::Instance",
      "Metadata" : {
        "Comment1" : "Configure the bootstrap helpers to install the Apache Web Server",

        "AWS::CloudFormation::Init" : {
          "configSets" : {
            "Install" : [ "Install" ]
          },

          "Install" : {
            "packages" : {
              "yum" : {
                "httpd" : []
              }
            },
            "services" : {
              "sysvinit" : {
                "httpd" : { "enabled" : "true", "ensureRunning" : "true" }
              }
            }
          }
        }
      },
      "CreationPolicy" : {
        "ResourceSignal" : {
          "Timeout" : "PT5M"
        }
      },
      "Properties" : {
        "ImageId" : "ami-4985b048",
        "InstanceType" : "t2.nano",
        "KeyName" : "macbook12",
        "Tags" : [
          { "Key" : "Name", "Value" : "Webサーバー" }
        ],
        "UserData" : {
          "Fn::Base64" :
            { "Fn::Join" :
              [
                "",
                [
                  "#!/bin/bash -xe\n",
                  "yum install -y aws-cfn-bootstrap\n",
                  "# Install the files and packages from the metadata\n",
                  "/opt/aws/bin/cfn-init -v ",
                  "         --stack ", { "Ref" : "AWS::StackName" },
                  "         --resource MyPublicEC2Instance ",
                  "         --configsets Install ",
                  "         --region ", { "Ref" : "AWS::Region" },
                  "\n",
                  "# Signal the status from cfn-init\n",
                  "/opt/aws/bin/cfn-signal -e $? ",
                  "         --stack ", { "Ref" : "AWS::StackName" },
                  "         --resource MyPublicEC2Instance ",
                  "         --region ", { "Ref" : "AWS::Region" },
                  "\n"
                ]
              ]
            }
        },
        "NetworkInterfaces": [
          {
            "AssociatePublicIpAddress": "true",
            "DeviceIndex": "0",
            "DeleteOnTermination" : "true",
            "PrivateIpAddress" : "10.0.1.10",
            "SubnetId": { "Ref" : "MyPublicSubnet" },
            "GroupSet": [ { "Ref" : "MyPublicSecurityGroup" } ]
          }
        ],
        "BlockDeviceMappings" : [
          {
            "DeviceName" : "/dev/xvda",
            "Ebs" : {
               "VolumeType" : "standard",
               "DeleteOnTermination" : "true",
               "VolumeSize" : "8"
            }
          }
        ]
      }
    },
    "MyPrivateEC2Instance": {
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "ImageId" : "ami-4985b048",
        "InstanceType" : "t2.nano",
        "KeyName" : "macbook12",
        "Tags" : [
          { "Key" : "Name", "Value" : "DBサーバー" }
        ],
        "NetworkInterfaces": [
          {
            "AssociatePublicIpAddress": "false",
            "DeviceIndex": "0",
            "DeleteOnTermination" : "true",
            "PrivateIpAddress" : "10.0.2.10",
            "SubnetId": { "Ref" : "MyPrivateSubnet" },
            "GroupSet": [ { "Ref" : "MyDatabaseSecurityGroup" } ]
          }
        ],
        "BlockDeviceMappings" : [
          {
            "DeviceName" : "/dev/xvda",
            "Ebs" : {
               "VolumeType" : "standard",
               "DeleteOnTermination" : "true",
               "VolumeSize" : "8"
            }
          }
        ]
      }
    }
  }
}
